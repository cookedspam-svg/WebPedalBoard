<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>STOMP-IT-TO-DEATH - PRO</title>
    <style>
        :root { --metal: #111; --chorus: #001a33; --delay: #002200; --flange: #330033; --wah: #332200; --accent: #ff4400; }
        body { background: #0a0a0a; color: white; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; }
        
        /* MENU STYLES */
        .menu-container { position: absolute; top: 10px; left: 10px; z-index: 1000; }
        .pancake-btn { 
            width: 30px; height: 30px; background: #333; border: 1px solid #555; border-radius: 4px; 
            cursor: pointer; display: flex; flex-direction: column; justify-content: space-around; padding: 5px; 
        }
        .pancake-btn span { width: 100%; height: 3px; background: #eee; border-radius: 2px; }
        .menu-content { 
            display: none; position: absolute; top: 35px; left: 0; background: #222; 
            border: 1px solid #444; padding: 10px; border-radius: 8px; width: 180px; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .menu-content.show { display: flex; flex-direction: column; gap: 10px; }
        .menu-item { display: flex; flex-direction: column; gap: 5px; font-size: 11px; color: #aaa; }
        .menu-content button, .menu-content select { width: 100%; padding: 5px; background: #111; color: white; border: 1px solid #444; cursor: pointer; font-size: 11px; text-align: left; }
        .menu-content button:hover { background: #333; }
        .btn-danger { color: #ff4444 !important; }

        .routing-panel { background: #222; padding: 15px; border-radius: 12px; border: 1px solid #444; margin-bottom: 15px; width: 95%; max-width: 1170px; margin-top: 15px; }
        .slot-container { display: flex; justify-content: space-around; align-items: center; gap: 5px; flex-wrap: wrap; }
        .slot { display: flex; flex-direction: column; align-items: center; gap: 5px; background: #2a2a2a; padding: 10px; border-radius: 8px; border: 1px solid #444; }
        select { background: #111; color: white; border: 1px solid #555; padding: 4px; border-radius: 4px; font-size: 11px; width: 110px; }
        .bypass-stomp { width: 100%; height: 25px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; font-size: 9px; background: #444; color: #888; }
        .bypass-stomp.active { background: #0f0; color: black; box-shadow: 0 0 8px #0f0; }

        .pedal-board { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; width: 100%; margin-bottom: 20px; }
        .pedal { width: 205px; border: 2px solid #333; border-radius: 10px; padding: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.8); }
        .mt2 { background: linear-gradient(180deg, #222, #000); border-color: var(--accent); }
        .cho { background: var(--chorus); border-color: #00ccff; }
        .flg { background: var(--flange); border-color: #ff00ff; }
        .wah { background: var(--wah); border-color: #ffcc00; }
        .dly { background: var(--delay); border-color: #00ff66; }
        
        h2 { font-size: 0.8rem; margin: 0 0 8px 0; text-transform: uppercase; text-align: center; }
        .knob-grid { display: grid; grid-template-columns: 1fr; gap: 6px; }
        .knob { display: flex; flex-direction: column; font-size: 9px; text-transform: uppercase; color: #aaa; }
        input[type=range] { width: 100%; cursor: pointer; accent-color: var(--accent); }

        .eq-container, .gate-container, .tube-container { background: #111; border: 1px solid #444; border-radius: 12px; padding: 25px; width: 95%; max-width: 1200px; margin-top: 10px; box-sizing: border-box; }
        
        .eq-grid { display: flex; justify-content: space-between; align-items: flex-end; gap: 10px; height: 360px; }
        .eq-slider-wrap { display: flex; flex-direction: column; align-items: center; flex: 1; height: 100%; }
        .eq-v-slider { -webkit-appearance: slider-vertical; writing-mode: bt-vertical; width: 20px !important; height: 300px !important; margin: 0 auto; }
        .eq-label { font-size: 11px; color: #888; margin-top: 12px; font-weight: bold; font-family: monospace; }
        .eq-mix-section { border-left: 2px solid #333; padding-left: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; }

        .horizontal-module { display: flex; align-items: center; gap: 20px; }
        .module-title { font-size: 0.75rem; color: #888; text-transform: uppercase; min-width: 150px; font-weight: bold; }
        .toggle-btn { padding: 8px 15px; border-radius: 4px; border: 1px solid #444; background: #222; color: #666; cursor: pointer; font-size: 10px; font-weight: bold; }
        
        /* Updated: All active toggle buttons now use the stomp box green (#0f0) */
        .toggle-btn.active { background: #0f0; color: black; border-color: #00ff00; box-shadow: 0 0 10px rgba(0,255,0,0.5); }

        .bottom-row { display: flex; gap: 15px; align-items: center; justify-content: center; width: 95%; max-width: 1200px; margin-bottom: 20px; margin-top: 20px; }
        
        .tuner-box { 
            width: 80px; height: 120px; background: #000; border: 2px solid #333; border-radius: 8px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px;
            padding: 5px;
        }
        .tuner-arrow { width: 0; height: 0; border-left: 20px solid transparent; border-right: 20px solid transparent; opacity: 0.2; transition: all 0.1s; }
        .arrow-up { border-bottom: 30px solid #f00; margin-bottom: 2px; }
        .arrow-down { border-top: 30px solid #f00; margin-top: 2px; }
        .tuner-note { 
            width: 50px; height: 40px; background: #444; color: #111; border-radius: 4px; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 24px; font-weight: bold; font-family: monospace;
        }
        .tuner-note.tuned { background: #99cc00; color: black; box-shadow: 0 0 15px #99cc00; }
        .arrow-up.active { border-bottom-color: #0f0; opacity: 1; filter: drop-shadow(0 0 8px #0f0); }
        .arrow-down.active { border-top-color: #f00; opacity: 1; filter: drop-shadow(0 0 8px #f00); }

        .recorder-box { background: #1a1a1a; border: 1px solid #444; border-radius: 8px; padding: 15px; width: 350px; display: flex; gap: 10px; align-items: center; height: 90px; }
        #recBtn { flex: 2; padding: 10px; font-weight: bold; cursor: pointer; border-radius: 5px; border: none; background: #333; color: white; }
        #recBtn.recording { background: #f00; animation: pulse 1s infinite; }
        #stereoBtn { flex: 1; padding: 10px; font-weight: bold; cursor: pointer; border-radius: 5px; border: 1px solid #444; background: #222; color: #666; font-size: 10px; }
        #stereoBtn.active { background: #00ccff; color: black; border-color: #fff; box-shadow: 0 0 10px rgba(0,204,255,0.4); }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .power-btn { padding: 12px 40px; font-size: 1.1rem; font-weight: bold; cursor: pointer; border-radius: 50px; border: 2px solid #444; background: #222; color: #666; margin-bottom: 15px; }
        
        /* Updated: Master power button now turns green (#0f0) when ON */
        .power-btn.on { background: #0f0; color: black; border-color: #00ff00; box-shadow: 0 0 15px rgba(0,255,0,0.5); }
    </style>
</head>
<body>

    <div class="menu-container">
        <button class="pancake-btn" onclick="document.getElementById('pancakeMenu').classList.toggle('show')">
            <span></span><span></span><span></span>
        </button>
        <div id="pancakeMenu" class="menu-content">
            <div class="menu-item">LOAD PRESET <select id="presetSelect" onchange="loadPreset(this.value)"><option value="">- Select -</option></select></div>
            <hr style="width:100%; border:0; border-top:1px solid #444;">
            <button onclick="savePreset()">SAVE PRESET</button>
            <button onclick="downloadPresets()">DOWNLOAD JSON</button>
            <button onclick="document.getElementById('importFile').click()">UPLOAD JSON</button>
            <hr style="width:100%; border:0; border-top:1px solid #444;">
            <button class="btn-danger" onclick="unloadPresets()">UNLOAD PRESETS (RESET)</button>
            <input type="file" id="importFile" style="display:none" onchange="uploadPresets(event)">
        </div>
    </div>

    <h1>STOMP-IT-TO-DEATH Guitar FX</h1>
    <button id="masterBtn" class="power-btn" onclick="toggleSystem()">OFF</button>

    <div class="tube-container">
        <div class="horizontal-module">
            <div class="module-title">Tube Preamp Emulator</div>
            <button id="tubeToggle" class="toggle-btn" onclick="toggleTubePower()">TUBE OFF</button>
            <div style="flex-grow: 1; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                <div style="display: flex; flex-direction: column; gap: 5px;"><span class="eq-label" style="margin-top:0">Drive</span><input type="range" min="1" max="20" step="0.1" value="5" id="tubeDrive" style="accent-color: var(--accent);"></div>
                <div style="display: flex; flex-direction: column; gap: 5px;"><span class="eq-label" style="margin-top:0">Tube Sag</span><input type="range" min="0" max="1" step="0.01" value="0.5" id="tubeSag" style="accent-color: var(--accent);"></div>
                <div style="display: flex; flex-direction: column; gap: 5px;"><span class="eq-label" style="margin-top:0">Output</span><input type="range" min="0" max="2" step="0.05" value="1" id="tubeOutput" style="accent-color: var(--accent);"></div>
            </div>
        </div>
    </div>

    <div class="routing-panel">
        <div class="slot-container">
            ðŸŽ¸
            <div class="slot"><select id="slot1" onchange="reconnectChain()"><option value="wah">Wah</option><option value="metal">MT-2</option><option value="chorus">Chorus</option><option value="flanger">Flanger</option><option value="delay">Delay</option><option value="bypass">Empty</option></select><button id="bp1" class="bypass-stomp" onclick="toggleBypass(0)">OFF</button></div> â†’
            <div class="slot"><select id="slot2" onchange="reconnectChain()"><option value="wah">Wah</option><option value="metal" selected>MT-2</option><option value="chorus">Chorus</option><option value="flanger">Flanger</option><option value="delay">Delay</option><option value="bypass">Empty</option></select><button id="bp2" class="bypass-stomp" onclick="toggleBypass(1)">OFF</button></div> â†’
            <div class="slot"><select id="slot3" onchange="reconnectChain()"><option value="wah">Wah</option><option value="metal">MT-2</option><option value="chorus" selected>Chorus</option><option value="flanger">Flanger</option><option value="delay">Delay</option><option value="bypass">Empty</option></select><button id="bp3" class="bypass-stomp" onclick="toggleBypass(2)">OFF</button></div> â†’
            <div class="slot"><select id="slot4" onchange="reconnectChain()"><option value="wah">Wah</option><option value="metal">MT-2</option><option value="chorus">Chorus</option><option value="flanger" selected>Flanger</option><option value="delay">Delay</option><option value="bypass">Empty</option></select><button id="bp4" class="bypass-stomp" onclick="toggleBypass(3)">OFF</button></div> â†’
            <div class="slot"><select id="slot5" onchange="reconnectChain()"><option value="wah">Wah</option><option value="metal">MT-2</option><option value="chorus">Chorus</option><option value="flanger">Flanger</option><option value="delay" selected>Delay</option><option value="bypass">Empty</option></select><button id="bp5" class="bypass-stomp" onclick="toggleBypass(4)">OFF</button></div> â†’ ðŸ”Š
        </div>
    </div>

    <div class="pedal-board">
        <div class="pedal mt2">
            <h2 style="color:var(--accent)">MZ-2</h2>
            <div class="knob-grid">
                <div class="knob">Gate <input type="range" min="-100" max="-10" value="-55" id="mtGate"></div>
                <div class="knob">Dist <input type="range" min="0" max="1000" value="650" id="mtDist"></div>
                <div class="knob">Low <input type="range" min="-15" max="15" value="6" id="mtLow"></div>
                <div class="knob">High <input type="range" min="-15" max="15" value="6" id="mtHigh"></div>
                <div class="knob">Mid Freq <input type="range" min="200" max="5000" value="1100" id="mtMidFreq"></div>
                <div class="knob">Mid Gain <input type="range" min="-15" max="15" value="-10" id="mtMidLevel"></div>
            </div>
        </div>
        <div class="pedal cho"><h2>Chorus</h2><div class="knob-grid"><div class="knob">Rate <input type="range" min="0.1" max="5" step="0.1" value="1.2" id="choRate"></div><div class="knob">Mix <input type="range" min="0" max="1" step="0.05" value="0.5" id="choMix"></div></div></div>
        <div class="pedal flg"><h2>Flanger</h2><div class="knob-grid"><div class="knob">Speed <input type="range" min="0.05" max="2" step="0.01" value="0.15" id="flgRate"></div><div class="knob">Mix <input type="range" min="0" max="1" step="0.05" value="0.5" id="flgMix"></div></div></div>
        <div class="pedal wah"><h2>Wah</h2><div class="knob-grid"><div class="knob">Sweep <input type="range" min="250" max="4000" value="1000" id="wahFreq"></div><div class="knob">Mix <input type="range" min="0" max="1" step="0.05" value="1.0" id="wahMix"></div></div></div>
        <div class="pedal dly"><h2>Delay</h2><div class="knob-grid"><div class="knob">Time <input type="range" min="0.1" max="1" step="0.05" value="0.4" id="dlyTime"></div><div class="knob">Mix <input type="range" min="0" max="1" step="0.05" value="0.4" id="dlyMix"></div></div></div>
    </div>

    <div class="bottom-row">
        <div class="tuner-box">
            <div id="tuneUp" class="tuner-arrow arrow-up"></div>
            <div id="tuneNote" class="tuner-note">--</div>
            <div id="tuneDown" class="tuner-arrow arrow-down"></div>
        </div>
        <canvas id="scope" width="600" height="120"></canvas>
        <div class="recorder-box">
            <button id="stereoBtn" onclick="toggleStereo()">STEREO OFF</button>
            <button id="recBtn" onclick="toggleRecording()">START RECORDING</button>
            <a id="downloadLink" download="guitar-take.ogg" style="display:none; color:#0f0; font-size:11px; text-decoration:none;">DL</a>
        </div>
    </div>

    <div class="eq-container">
        <h2 style="text-align:left; font-size: 0.8rem; color: #888; margin-bottom: 20px;">MASTER 12-BAND GRAPHIC EQ</h2>
        <div class="eq-grid" id="eqBars">
            <div class="eq-mix-section">
                <span class="eq-label" style="color:white; margin-bottom:15px;">EQ MIX</span>
                <input type="range" orient="vertical" class="eq-v-slider" min="0" max="1" step="0.05" value="1" id="eqMix">
            </div>
        </div>
    </div>

    <div class="gate-container">
        <div class="horizontal-module">
            <div class="module-title">Master Noise Gate</div>
            <button id="gateToggle" class="toggle-btn" onclick="toggleGatePower()">GATE OFF</button>
            <div style="flex-grow: 1; display: flex; flex-direction: column; gap: 5px;">
                <span class="eq-label" style="margin-top:0">Threshold (dB)</span>
                <input type="range" min="-100" max="-20" step="1" value="-60" id="masterGateThreshold" style="accent-color: var(--accent);">
            </div>
        </div>
    </div>

    <script>
        let audioCtx, mic, analyzer, tunerAnalyzer, masterLimiter, recorder, recDestination;
        let chunks = [];
        let slots = [null, null, null, null, null]; 
        // Initialized all slots to BYPASS (true)
        let bypassStates = [true, true, true, true, true];
        let eqFilters = [];
        let eqDry, eqWet, stereoNode, isStereo = false;
        
        let masterGateNode, tubeAmpNode, tubeGainIn, tubeGainOut;
        // Initialized Gate and Tube to OFF (false)
        let isGateOn = false, isTubeOn = false;

        const eqFreqs = [32, 64, 125, 250, 500, 1000, 2000, 4000, 6000, 8000, 12000, 16000];
        const noteStrings = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];

        const eqBars = document.getElementById('eqBars');
        eqFreqs.forEach((f, i) => {
            const div = document.createElement('div');
            div.className = 'eq-slider-wrap';
            div.innerHTML = `<input type="range" orient="vertical" class="eq-v-slider" min="-18" max="18" step="0.5" value="0" id="eq${i}" oninput="updateParams()"><span class="eq-label">${f < 1000 ? f : (f/1000)+'k'}</span>`;
            eqBars.insertBefore(div, eqBars.lastElementChild);
        });

        async function toggleSystem() {
            const btn = document.getElementById('masterBtn');
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const stream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false } });
                mic = audioCtx.createMediaStreamSource(stream);
                
                analyzer = audioCtx.createAnalyser();
                tunerAnalyzer = audioCtx.createAnalyser(); 
                tunerAnalyzer.fftSize = 2048;

                masterLimiter = audioCtx.createDynamicsCompressor();
                masterGateNode = audioCtx.createDynamicsCompressor();
                masterGateNode.ratio.value = 20;

                tubeAmpNode = audioCtx.createWaveShaper();
                tubeGainIn = audioCtx.createGain(); tubeGainOut = audioCtx.createGain();
                
                eqDry = audioCtx.createGain(); eqWet = audioCtx.createGain();
                eqFilters = eqFreqs.map(f => {
                    const filter = audioCtx.createBiquadFilter();
                    filter.type = "peaking"; filter.frequency.value = f; filter.Q.value = 1.2; 
                    return filter;
                });
                for(let i=0; i<eqFilters.length-1; i++) eqFilters[i].connect(eqFilters[i+1]);
                
                recDestination = audioCtx.createMediaStreamDestination();
                recorder = new MediaRecorder(recDestination.stream);
                recorder.ondataavailable = e => chunks.push(e.data);
                recorder.onstop = exportAudio;
                
                reconnectChain();
                draw();
                btn.innerText = "POWER ON"; btn.classList.add('on');
            } else {
                if (audioCtx.state === 'running') { await audioCtx.suspend(); btn.innerText = "OFF"; btn.classList.remove('on'); }
                else { await audioCtx.resume(); btn.innerText = "POWER ON"; btn.classList.add('on'); }
            }
        }

        function reconnectChain() {
            if (!mic) return;
            mic.disconnect();
            masterLimiter.disconnect();
            masterGateNode.disconnect();
            tubeGainOut.disconnect();
            eqDry.disconnect();
            eqWet.disconnect();
            analyzer.disconnect();

            mic.connect(tunerAnalyzer);

            slots.forEach(s => { if(s) { s.in.disconnect(); s.out.disconnect(); if(s.lfo) try{s.lfo.stop();}catch(e){} } });
            
            for(let i=0; i<5; i++) {
                const type = document.getElementById(`slot${i+1}`).value;
                if (type === 'bypass' || bypassStates[i]) slots[i] = createBypass();
                else slots[i] = window[`create${type.charAt(0).toUpperCase() + type.slice(1)}`]();
            }

            mic.connect(slots[0].in);
            slots[0].out.connect(slots[1].in); slots[1].out.connect(slots[2].in); 
            slots[2].out.connect(slots[3].in); slots[3].out.connect(slots[4].in); 
            slots[4].out.connect(masterLimiter);

            masterLimiter.connect(eqDry); 
            masterLimiter.connect(eqFilters[0]);
            eqFilters[eqFilters.length-1].connect(eqWet);

            const eqOutNode = audioCtx.createGain();
            eqDry.connect(eqOutNode); eqWet.connect(eqOutNode);

            let lastNode = eqOutNode;
            if (isGateOn) { lastNode.connect(masterGateNode); lastNode = masterGateNode; }
            if (isTubeOn) { 
                lastNode.connect(tubeGainIn); tubeGainIn.connect(tubeAmpNode); 
                tubeAmpNode.connect(tubeGainOut); lastNode = tubeGainOut; 
            }

            const finalNode = audioCtx.createGain();
            lastNode.connect(finalNode);

            if (isStereo) {
                stereoNode = createHaas(); finalNode.connect(stereoNode.in); 
                stereoNode.out.connect(analyzer); 
                stereoNode.out.connect(recDestination); 
                analyzer.connect(audioCtx.destination);
            } else {
                finalNode.connect(analyzer); 
                finalNode.connect(recDestination); 
                analyzer.connect(audioCtx.destination);
            }
            updateParams();
        }

        function updateParams() {
            if (!audioCtx) return;
            slots.forEach(s => {
                if (s.type === 'metal') {
                    const k = parseFloat(document.getElementById('mtDist').value);
                    const n = 44100; const curve = new Float32Array(n);
                    for (let i=0; i<n; i++) { let x = (i*2)/n-1; curve[i] = (3+k)*x*10*(Math.PI/180)/(Math.PI+k*Math.abs(x)); }
                    s.dist.curve = curve; s.gate.threshold.value = document.getElementById('mtGate').value;
                    s.low.gain.value = document.getElementById('mtLow').value; s.high.gain.value = document.getElementById('mtHigh').value;
                    s.mid.frequency.value = document.getElementById('mtMidFreq').value; s.mid.gain.value = document.getElementById('mtMidLevel').value;
                }
                if (s.type === 'chorus') { s.wet.gain.value = document.getElementById('choMix').value; s.dry.gain.value = 1-document.getElementById('choMix').value; s.lfo.frequency.value = document.getElementById('choRate').value; s.lfoG.gain.value = 0.002; }
                if (s.type === 'flanger') { s.wet.gain.value = document.getElementById('flgMix').value; s.dry.gain.value = 1-document.getElementById('flgMix').value; s.lfo.frequency.value = document.getElementById('flgRate').value; }
                
                if (s.type === 'wah') { 
                    const mix = parseFloat(document.getElementById('wahMix').value);
                    s.filter.frequency.setTargetAtTime(document.getElementById('wahFreq').value, audioCtx.currentTime, 0.05); 
                    s.wet.gain.value = mix * 4.0; 
                    s.dry.gain.value = 1 - mix; 
                }

                if (s.type === 'delay') { s.dly.delayTime.setTargetAtTime(document.getElementById('dlyTime').value, audioCtx.currentTime, 0.1); s.wet.gain.value = document.getElementById('dlyMix').value; }
            });
            eqFreqs.forEach((f, i) => { if(eqFilters[i]) eqFilters[i].gain.value = document.getElementById(`eq${i}`).value; });
            eqWet.gain.value = document.getElementById('eqMix').value; eqDry.gain.value = 1 - document.getElementById('eqMix').value;
            masterGateNode.threshold.value = document.getElementById('masterGateThreshold').value;
            const drive = document.getElementById('tubeDrive').value, sag = document.getElementById('tubeSag').value;
            tubeAmpNode.curve = makeTubeCurve(drive, sag); tubeGainIn.gain.value = drive * 0.5; tubeGainOut.gain.value = document.getElementById('tubeOutput').value;
        }

        function autoCorrelate(buf, sampleRate) {
            let SIZE = buf.length, rms = 0;
            for (let i = 0; i < SIZE; i++) { const val = buf[i]; rms += val * val; }
            rms = Math.sqrt(rms / SIZE);
            if (rms < 0.01) return -1;
            let r1 = 0, r2 = SIZE - 1, thres = 0.2;
            for (let i = 0; i < SIZE / 2; i++) if (Math.abs(buf[i]) < thres) { r1 = i; break; }
            for (let i = 1; i < SIZE / 2; i++) if (Math.abs(buf[SIZE - i]) < thres) { r2 = SIZE - i; break; }
            buf = buf.slice(r1, r2); SIZE = buf.length;
            let c = new Array(SIZE).fill(0);
            for (let i = 0; i < SIZE; i++) for (let j = 0; j < SIZE - i; j++) c[i] = c[i] + buf[j] * buf[j + i];
            let d = 0; while (c[d] > c[d + 1]) d++;
            let maxval = -1, maxpos = -1;
            for (let i = d; i < SIZE; i++) if (c[i] > maxval) { maxval = c[i]; maxpos = i; }
            let T0 = maxpos;
            let x1 = c[T0-1], x2 = c[T0], x3 = c[T0+1];
            let a = (x1 + x3 - 2 * x2) / 2, b = (x3 - x1) / 2;
            if (a) T0 = T0 - b / (2 * a);
            return sampleRate / T0;
        }

        function draw() {
            requestAnimationFrame(draw);
            const canvas = document.getElementById('scope'), c = canvas.getContext('2d');
            const data = new Uint8Array(analyzer.frequencyBinCount);
            analyzer.getByteTimeDomainData(data);
            c.fillStyle = 'black'; c.fillRect(0,0,600,120);
            c.strokeStyle = '#ff4400'; c.lineWidth = 2; c.beginPath();
            let x = 0, slice = 600 / data.length;
            for(let i=0; i<data.length; i++) { let v = data[i]/128.0, y = v * 60; i===0 ? c.moveTo(x,y) : c.lineTo(x,y); x += slice; }
            c.stroke();

            if (tunerAnalyzer && audioCtx.state === 'running') {
                const buf = new Float32Array(tunerAnalyzer.fftSize);
                tunerAnalyzer.getFloatTimeDomainData(buf);
                const freq = autoCorrelate(buf, audioCtx.sampleRate);
                const nDisplay = document.getElementById('tuneNote'), upA = document.getElementById('tuneUp'), dwA = document.getElementById('tuneDown');
                upA.classList.remove('active'); dwA.classList.remove('active'); nDisplay.classList.remove('tuned');
                if (freq !== -1) {
                    const noteNum = 12 * (Math.log(freq / 440) / Math.log(2)) + 69;
                    const noteIndex = Math.round(noteNum), detune = Math.floor((noteNum - noteIndex) * 100);
                    nDisplay.innerText = noteStrings[noteIndex % 12];
                    if (Math.abs(detune) < 5) nDisplay.classList.add('tuned');
                    else if (detune < -5) upA.classList.add('active'); else dwA.classList.add('active');
                } else { nDisplay.innerText = "--"; }
            }
        }

        function toggleBypass(i) { bypassStates[i] = !bypassStates[i]; document.getElementById(`bp${i+1}`).innerText = bypassStates[i] ? "OFF" : "ON"; document.getElementById(`bp${i+1}`).classList.toggle('active', !bypassStates[i]); reconnectChain(); }
        function toggleGatePower() { isGateOn = !isGateOn; refreshUIState(); reconnectChain(); }
        function toggleTubePower() { isTubeOn = !isTubeOn; refreshUIState(); reconnectChain(); }
        function toggleStereo() { isStereo = !isStereo; refreshUIState(); reconnectChain(); }
        function refreshUIState() {
            document.getElementById('stereoBtn').innerText = isStereo ? "STEREO ON" : "STEREO OFF"; document.getElementById('stereoBtn').classList.toggle('active', isStereo);
            document.getElementById('gateToggle').innerText = isGateOn ? "GATE ON" : "GATE OFF"; document.getElementById('gateToggle').classList.toggle('active', isGateOn);
            document.getElementById('tubeToggle').innerText = isTubeOn ? "TUBE ON" : "TUBE OFF"; document.getElementById('tubeToggle').classList.toggle('active', isTubeOn);
        }
        function makeTubeCurve(drive, sag) { const n = 44100; const curve = new Float32Array(n); for (let i = 0; i < n; i++) { let x = (i * 2) / n - 1; if (x > 0) curve[i] = (1 - Math.exp(-drive * x)) * (1 - sag * 0.2); else curve[i] = - (1 - Math.exp(drive * x * 0.8)); } return curve; }
        function createBypass() { const n = { in: audioCtx.createGain(), out: audioCtx.createGain(), type: 'bypass' }; n.in.connect(n.out); return n; }
        function createHaas() { const c = audioCtx; const input = c.createGain(), merger = c.createChannelMerger(2), delay = c.createDelay(); delay.delayTime.value = 0.02; input.connect(merger, 0, 0); input.connect(delay); delay.connect(merger, 0, 1); return { in: input, out: merger }; }
        function toggleRecording() { if (recorder.state === "inactive") { chunks = []; recorder.start(); document.getElementById('recBtn').innerText = "STOP"; document.getElementById('recBtn').classList.add('recording'); } else { recorder.stop(); document.getElementById('recBtn').innerText = "START"; document.getElementById('recBtn').classList.remove('recording'); } }
        function exportAudio() { const blob = new Blob(chunks, { type: 'audio/ogg; codecs=opus' }); const link = document.getElementById('downloadLink'); link.href = URL.createObjectURL(blob); link.style.display = "inline-block"; }
        document.querySelectorAll('input').forEach(i => i.oninput = updateParams);
        window.onclick = e => { if (!e.target.closest('.pancake-btn') && !e.target.closest('.menu-content')) document.getElementById('pancakeMenu').classList.remove('show'); };

        function createMetal() { const c = audioCtx; const n = { in: c.createGain(), gate: c.createDynamicsCompressor(), dist: c.createWaveShaper(), low: c.createBiquadFilter(), high: c.createBiquadFilter(), mid: c.createBiquadFilter(), out: c.createGain(), type: 'metal' }; n.gate.ratio.value = 20; n.low.type = "lowshelf"; n.low.frequency.value = 120; n.high.type = "highshelf"; n.high.frequency.value = 3800; n.mid.type = "peaking"; n.mid.Q.value = 1.4; n.in.connect(n.gate); n.gate.connect(n.dist); n.dist.connect(n.low); n.low.connect(n.high); n.high.connect(n.mid); n.mid.connect(n.out); return n; }
        function createChorus() { const c = audioCtx; const n = { in: c.createGain(), dry: c.createGain(), wet: c.createGain(), dly: c.createDelay(), lfo: c.createOscillator(), lfoG: c.createGain(), out: c.createGain(), type: 'chorus' }; n.dly.delayTime.value = 0.03; n.lfo.type = 'sine'; n.lfo.connect(n.lfoG); n.lfoG.connect(n.dly.delayTime); n.in.connect(n.dry); n.in.connect(n.dly); n.dly.connect(n.wet); n.dry.connect(n.out); n.wet.connect(n.out); n.lfo.start(); return n; }
        function createFlanger() { const c = audioCtx; const n = { in: c.createGain(), dry: c.createGain(), wet: c.createGain(), dly: c.createDelay(), lfo: c.createOscillator(), lfoG: c.createGain(), fb: c.createGain(), out: c.createGain(), type: 'flanger' }; n.dly.delayTime.value = 0.005; n.lfo.connect(n.lfoG); n.lfoG.connect(n.dly.delayTime); n.in.connect(n.dry); n.in.connect(n.dly); n.dly.connect(n.fb); n.fb.connect(n.dly); n.dly.connect(n.wet); n.dry.connect(n.out); n.wet.connect(n.out); n.lfo.start(); n.lfoG.gain.value = 0.002; n.fb.gain.value = 0.5; return n; }
        function createWah() { const c = audioCtx; const n = { in: c.createGain(), dry: c.createGain(), wet: c.createGain(), filter: c.createBiquadFilter(), out: c.createGain(), type: 'wah' }; n.filter.type = "bandpass"; n.filter.Q.value = 15; n.in.connect(n.dry); n.in.connect(n.filter); n.filter.connect(n.wet); n.dry.connect(n.out); n.wet.connect(n.out); return n; }
        function createDelay() { const c = audioCtx; const n = { in: c.createGain(), dry: c.createGain(), wet: c.createGain(), dly: c.createDelay(2.0), fb: c.createGain(), out: c.createGain(), type: 'delay' }; n.in.connect(n.dry); n.in.connect(n.dly); n.dly.connect(n.fb); n.fb.connect(n.dly); n.dly.connect(n.wet); n.dry.connect(n.out); n.wet.connect(n.out); n.fb.gain.value=0.3; return n; }
    </script>
</body>
</html>
